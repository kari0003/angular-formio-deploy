!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("lodash"),require("formiojs"),require("angular-formio"),require("@angular/router"),require("@angular/common")):"function"==typeof define&&define.amd?define("angular-formio/auth",["exports","@angular/core","lodash","formiojs","angular-formio","@angular/router","@angular/common"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self)["angular-formio"]=e["angular-formio"]||{},e["angular-formio"].auth={}),e.ng.core,e._,e.formiojs,e["angular-formio"],e.ng.router,e.ng.common)}(this,(function(e,t,o,n,r,i,s){"use strict";var a,c=function(){};c.ɵfac=function(e){return new(e||c)},c.ɵprov=t.ɵɵdefineInjectable({token:c,factory:c.ɵfac}),function(e){e.okta="okta",e.saml="saml"}(a||(a={}));var u=function(){function e(e,r){var i=this;this.appConfig=e,this.config=r,this.authenticated=!1,this.formAccess={},this.submissionAccess={},this.is={},this.user=null,this.appConfig&&this.appConfig.appUrl?(n.Formio.setBaseUrl(this.appConfig.apiUrl),n.Formio.setProjectUrl(this.appConfig.appUrl),n.Formio.formOnly=!!this.appConfig.formOnly):console.error("You must provide an AppConfig within your application!"),this.loginForm=this.appConfig.appUrl+"/"+o.get(this.config,"login.form","user/login"),this.registerForm=this.appConfig.appUrl+"/"+o.get(this.config,"register.form","user/register"),this.onLogin=new t.EventEmitter,this.onLogout=new t.EventEmitter,this.onRegister=new t.EventEmitter,this.onUser=new t.EventEmitter,this.onError=new t.EventEmitter,this.ready=new Promise((function(e,t){i.readyResolve=e,i.readyReject=t})),n.Formio.events.on("formio.badToken",(function(){return i.logoutError()})),n.Formio.events.on("formio.sessionExpired",(function(){return i.logoutError()})),this.config.delayAuth||this.init()}return e.prototype.onLoginSubmit=function(e){this.setUser(e),this.onLogin.emit(e)},e.prototype.onRegisterSubmit=function(e){this.setUser(e),this.onRegister.emit(e)},e.prototype.init=function(){var e,t=this;this.projectReady=n.Formio.makeStaticRequest(this.appConfig.appUrl).then((function(e){o.each(e.access,(function(e){t.formAccess[e.type]=e.roles}))}),(function(){return t.formAccess={},null})),this.accessReady=n.Formio.makeStaticRequest(this.appConfig.appUrl+"/access").then((function(e){return o.each(e.forms,(function(e){t.submissionAccess[e.name]={},e.submissionAccess.forEach((function(o){t.submissionAccess[e.name][o.type]=o.roles}))})),t.roles=e.roles,e}),(function(){return t.roles={},null})),this.config.oauth?(window.location.hash&&window.location.hash.match(/^#\/access_token/)&&history.pushState(null,null,window.location.hash.replace(/^#\/access_token/,"#access_token")),e=n.Formio.ssoInit(this.config.oauth.type,this.config.oauth.options)):e=n.Formio.currentUser(),this.userReady=e.then((function(e){return t.setUser(e),e})),this.accessReady&&this.accessReady.then((function(){return t.projectReady})).then((function(){return t.userReady})).then((function(){return t.readyResolve(!0)})).catch((function(e){return t.readyReject(e)}))},e.prototype.setUser=function(e){var t=n.Formio.namespace||"formio";e?(this.user=e,localStorage.setItem(t+"AppUser",JSON.stringify(e)),this.setUserRoles()):(this.user=null,this.is={},localStorage.removeItem(t+"AppUser"),n.Formio.clearCache(),n.Formio.setUser(null)),this.authenticated=!!n.Formio.getToken(),this.onUser.emit(this.user)},e.prototype.setUserRoles=function(){var e=this;this.accessReady&&this.accessReady.then((function(){o.each(e.roles,(function(t,o){-1!==e.user.roles.indexOf(t._id)&&(e.is[o]=!0)}))}))},e.prototype.logoutError=function(){this.setUser(null);var e=n.Formio.namespace||"formio";localStorage.removeItem(e+"Token"),this.onError.emit()},e.prototype.logout=function(){var e=this;this.setUser(null);var t=n.Formio.namespace||"formio";localStorage.removeItem(t+"Token"),n.Formio.logout().then((function(){return e.onLogout.emit()})).catch((function(){return e.logoutError()}))},e}();u.ɵfac=function(e){return new(e||u)(t.ɵɵinject(r.FormioAppConfig),t.ɵɵinject(c))},u.ɵprov=t.ɵɵdefineInjectable({token:u,factory:u.ɵfac});var l=function(){};l.ɵfac=function(e){return new(e||l)},l.ɵcmp=t.ɵɵdefineComponent({type:l,selectors:[["ng-component"]],decls:11,vars:0,consts:[[1,"card","card-primary","panel","panel-default"],[1,"card-header","panel-heading"],[1,"nav","nav-tabs","card-header-tabs"],["role","presentation","routerLinkActive","active",1,"nav-item"],["routerLink","login","routerLinkActive","active",1,"nav-link"],["routerLink","register","routerLinkActive","active",1,"nav-link"],[1,"card-body","panel-body"]],template:function(e,o){1&e&&(t.ɵɵelementStart(0,"div",0),t.ɵɵelementStart(1,"div",1),t.ɵɵelementStart(2,"ul",2),t.ɵɵelementStart(3,"li",3),t.ɵɵelementStart(4,"a",4),t.ɵɵtext(5,"Login"),t.ɵɵelementEnd(),t.ɵɵelementEnd(),t.ɵɵelementStart(6,"li",3),t.ɵɵelementStart(7,"a",5),t.ɵɵtext(8,"Register"),t.ɵɵelementEnd(),t.ɵɵelementEnd(),t.ɵɵelementEnd(),t.ɵɵelementEnd(),t.ɵɵelementStart(9,"div",6),t.ɵɵelement(10,"router-outlet"),t.ɵɵelementEnd(),t.ɵɵelementEnd())},directives:[i.RouterLinkActive,i.RouterLinkWithHref,i.RouterOutlet],encapsulation:2});var m=function(e){this.service=e};m.ɵfac=function(e){return new(e||m)(t.ɵɵdirectiveInject(u))},m.ɵcmp=t.ɵɵdefineComponent({type:m,selectors:[["ng-component"]],decls:1,vars:1,consts:[[3,"src","submit"]],template:function(e,o){1&e&&(t.ɵɵelementStart(0,"formio",0),t.ɵɵlistener("submit",(function(e){return o.service.onLoginSubmit(e)})),t.ɵɵelementEnd()),2&e&&t.ɵɵproperty("src",o.service.loginForm)},directives:[r.FormioComponent],encapsulation:2});var f=function(e){this.service=e};function p(e){return[{path:"",component:e&&e.auth?e.auth:l,children:[{path:"",redirectTo:"login",pathMatch:"full"},{path:"login",component:e&&e.login?e.login:m},{path:"register",component:e&&e.register?e.register:f}]}]}f.ɵfac=function(e){return new(e||f)(t.ɵɵdirectiveInject(u))},f.ɵcmp=t.ɵɵdefineComponent({type:f,selectors:[["ng-component"]],decls:1,vars:1,consts:[[3,"src","submit"]],template:function(e,o){1&e&&(t.ɵɵelementStart(0,"formio",0),t.ɵɵlistener("submit",(function(e){return o.service.onRegisterSubmit(e)})),t.ɵɵelementEnd()),2&e&&t.ɵɵproperty("src",o.service.registerForm)},directives:[r.FormioComponent],encapsulation:2});var h=function(){function e(){}return e.forRoot=function(t){return r.extendRouter(e,t,p)},e.forChild=function(t){return r.extendRouter(e,t,p)},e}();h.ɵmod=t.ɵɵdefineNgModule({type:h}),h.ɵinj=t.ɵɵdefineInjector({factory:function(e){return new(e||h)},imports:[[s.CommonModule,r.FormioModule,i.RouterModule]]}),("undefined"==typeof ngJitMode||ngJitMode)&&t.ɵɵsetNgModuleScope(h,{declarations:[l,m,f],imports:[s.CommonModule,r.FormioModule,i.RouterModule]}),e.FormioAuth=h,e.FormioAuthComponent=l,e.FormioAuthConfig=c,e.FormioAuthLoginComponent=m,e.FormioAuthRegisterComponent=f,e.FormioAuthRoutes=p,e.FormioAuthService=u,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=angular-formio-auth.umd.min.js.map