!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("angular-formio/auth"),require("angular-formio"),require("native-promise-only"),require("formiojs"),require("lodash"),require("@angular/router"),require("@angular/common"),require("angular-formio/grid")):"function"==typeof define&&define.amd?define("angular-formio/resource",["exports","@angular/core","angular-formio/auth","angular-formio","native-promise-only","formiojs","lodash","@angular/router","@angular/common","angular-formio/grid"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self)["angular-formio"]=e["angular-formio"]||{},e["angular-formio"].resource={}),e.ng.core,e["angular-formio"].auth,e["angular-formio"],e.Promise,e.formiojs,e._,e.ng.router,e.ng.common,e["angular-formio"].grid)}(this,(function(e,t,r,o,n,i,s,c,u,a){"use strict";function f(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var m=f(n),l=f(s),h=function(){this.name="",this.form="",this.parents=[]};h.ɵfac=function(e){return new(e||h)},h.ɵprov=t.ɵɵdefineInjectable({token:h,factory:h.ɵfac});var d=function(e){this.auth=e,this.resources={},this.error=new t.EventEmitter,this.onError=this.error,this.resources={currentUser:{resourceLoaded:this.auth.userReady}}};d.ɵfac=function(e){return new(e||d)(t.ɵɵinject(r.FormioAuthService))},d.ɵprov=t.ɵɵdefineInjectable({token:d,factory:d.ɵfac});var p=function(){function e(e,r,n,i){var s=this;this.appConfig=e,this.config=r,this.resourcesService=n,this.appRef=i,this.initialized=!1,this.isLoading=!0,this.alerts=new o.FormioAlerts,this.refresh=new t.EventEmitter,this.formLoaded=new m.default((function(e,t){s.formResolve=e,s.formReject=t})),this.init()}return e.prototype.initialize=function(){console.warn("FormioResourceService.initialize() has been deprecated.")},e.prototype.init=function(){if(!this.initialized)return this.initialized=!0,this.appConfig&&this.appConfig.appUrl?(i.Formio.setBaseUrl(this.appConfig.apiUrl),i.Formio.setProjectUrl(this.appConfig.appUrl),i.Formio.formOnly=this.appConfig.formOnly):console.error("You must provide an AppConfig within your application!"),this.formUrl=this.appConfig.appUrl+"/"+this.config.form,this.resource={data:{}},this.resourcesService&&(this.resources=this.resourcesService.resources,this.resources[this.config.name]=this),this.loadForm()},e.prototype.onError=function(e){throw this.alerts.setAlert({type:"danger",message:e.message||e}),this.resourcesService&&this.resourcesService.error.emit(e),e},e.prototype.onFormError=function(e){this.formReject(e),this.onError(e)},e.prototype.setContext=function(e){this.resourceId=e.snapshot.params.id,this.resource={data:{}},this.resourceUrl=this.appConfig.appUrl+"/"+this.config.form,this.resourceId&&(this.resourceUrl+="/submission/"+this.resourceId),this.formio=new o.FormioPromiseService(this.resourceUrl),this.resourcesService&&(this.resources[this.config.name]=this),this.loadParents()},e.prototype.loadForm=function(){var e=this;return this.formFormio=new o.FormioPromiseService(this.formUrl),this.isLoading=!0,this.formLoading=this.formFormio.loadForm().then((function(t){return e.form=t,e.formResolve(t),e.isLoading=!1,e.loadParents(),t}),(function(t){return e.onFormError(t)})).catch((function(t){return e.onFormError(t)})),this.formLoading},e.prototype.loadParents=function(){var e=this;return this.config.parents&&this.config.parents.length?this.resourcesService?this.formLoading.then((function(t){var r=[];return e.config.parents.forEach((function(o){var n=o.resource||o,s=o.field||o,c=!o.hasOwnProperty("filter")||o.filter;e.resources.hasOwnProperty(n)&&e.resources[n].resourceLoaded&&r.push(e.resources[n].resourceLoaded.then((function(r){var o="";return i.Utils.eachComponent(t.components,(function(t,n){if(t.key===s)return t.hidden=!0,t.clearOnHide=!1,l.default.set(e.resource.data,n,r),o=n,!0})),{name:o,filter:c,resource:r}})))})),m.default.all(r).then((function(r){return e.refresh.emit({form:t,submission:e.resource}),r}))})):(console.warn("You must provide the FormioResources within your application to use nested resources."),m.default.resolve([])):m.default.resolve([])},e.prototype.onSubmissionError=function(e){this.onError(e)},e.prototype.loadResource=function(e){var t=this;return this.setContext(e),this.isLoading=!0,this.resourceLoading=this.resourceLoaded=this.formio.loadSubmission(null,{ignoreCache:!0}).then((function(e){return t.resource=e,t.isLoading=!1,t.refresh.emit({property:"submission",value:t.resource}),e}),(function(e){return t.onSubmissionError(e)})).catch((function(e){return t.onSubmissionError(e)})),this.resourceLoading},e.prototype.save=function(e){var t=this;return(e._id?this.formio:this.formFormio).saveSubmission(e).then((function(e){return t.resource=e,e}),(function(e){return t.onError(e)})).catch((function(e){return t.onError(e)}))},e.prototype.remove=function(){var e=this;return this.formio.deleteSubmission().then((function(){e.resource=null}),(function(t){return e.onError(t)})).catch((function(t){return e.onError(t)}))},e}();function v(e,r){1&e&&(t.ɵɵelementStart(0,"li",4),t.ɵɵelementStart(1,"a",7),t.ɵɵtext(2,"Edit"),t.ɵɵelementEnd(),t.ɵɵelementEnd())}function g(e,r){1&e&&(t.ɵɵelementStart(0,"li",4),t.ɵɵelementStart(1,"a",8),t.ɵɵelement(2,"span",9),t.ɵɵelementEnd(),t.ɵɵelementEnd())}p.ɵfac=function(e){return new(e||p)(t.ɵɵinject(o.FormioAppConfig),t.ɵɵinject(h),t.ɵɵinject(d,8),t.ɵɵinject(t.ApplicationRef))},p.ɵprov=t.ɵɵdefineInjectable({token:p,factory:p.ɵfac});var y=function(){function e(e,t,r){var o=this;this.service=e,this.route=t,this.auth=r,this.perms={delete:!1,edit:!1},this.paramsSubscription=this.route.params.subscribe((function(e){o.init()}))}return e.prototype.ngOnInit=function(){this.init()},e.prototype.init=function(){var e=this;this.service.loadResource(this.route),this.service.formLoaded.then((function(t){e.auth.ready.then((function(){e.service.resourceLoaded.then((function(r){e.service.formFormio.userPermissions(e.auth.user,t,r).then((function(t){e.perms.delete=t.delete,e.perms.edit=t.edit}))}))}))}))},e.prototype.ngOnDestroy=function(){this.paramsSubscription&&this.paramsSubscription.unsubscribe()},e}();y.ɵfac=function(e){return new(e||y)(t.ɵɵdirectiveInject(p),t.ɵɵdirectiveInject(c.ActivatedRoute),t.ɵɵdirectiveInject(r.FormioAuthService))},y.ɵcmp=t.ɵɵdefineComponent({type:y,selectors:[["ng-component"]],decls:10,vars:2,consts:[[1,"nav","nav-tabs",2,"margin-bottom","10px"],[1,"nav-item"],["routerLink","../",1,"nav-link"],[1,"fa","fa-chevron-left","glyphicon","glyphicon-chevron-left"],["routerLinkActive","active",1,"nav-item"],["routerLink","view","routerLinkActive","active",1,"nav-link"],["class","nav-item","routerLinkActive","active",4,"ngIf"],["routerLink","edit","routerLinkActive","active",1,"nav-link"],["routerLink","delete","routerLinkActive","active",1,"nav-link"],[1,"fa","fa-trash","glyphicon","glyphicon-trash"]],template:function(e,r){1&e&&(t.ɵɵelementStart(0,"ul",0),t.ɵɵelementStart(1,"li",1),t.ɵɵelementStart(2,"a",2),t.ɵɵelement(3,"i",3),t.ɵɵelementEnd(),t.ɵɵelementEnd(),t.ɵɵelementStart(4,"li",4),t.ɵɵelementStart(5,"a",5),t.ɵɵtext(6,"View"),t.ɵɵelementEnd(),t.ɵɵelementEnd(),t.ɵɵtemplate(7,v,3,0,"li",6),t.ɵɵtemplate(8,g,3,0,"li",6),t.ɵɵelementEnd(),t.ɵɵelement(9,"router-outlet")),2&e&&(t.ɵɵadvance(7),t.ɵɵproperty("ngIf",r.perms.edit),t.ɵɵadvance(1),t.ɵɵproperty("ngIf",r.perms.delete))},directives:[c.RouterLinkWithHref,c.RouterLinkActive,u.NgIf,c.RouterOutlet],encapsulation:2});var b=function(e,t){this.service=e,this.config=t};b.ɵfac=function(e){return new(e||b)(t.ɵɵdirectiveInject(p),t.ɵɵdirectiveInject(h))},b.ɵcmp=t.ɵɵdefineComponent({type:b,selectors:[["ng-component"]],decls:1,vars:5,consts:[[3,"form","submission","refresh","hideComponents","readOnly"]],template:function(e,r){1&e&&t.ɵɵelement(0,"formio",0),2&e&&t.ɵɵproperty("form",r.service.form)("submission",r.service.resource)("refresh",r.service.refresh)("hideComponents",r.config.parents)("readOnly",!0)},directives:[o.FormioComponent],encapsulation:2});var S=function(){function e(e,r,o,n){this.service=e,this.route=r,this.router=o,this.config=n,this.triggerError=new t.EventEmitter}return e.prototype.onSubmit=function(e){var t=this,r=this.service.resource;r.data=e.data,this.service.save(r).then((function(){t.router.navigate(["../","view"],{relativeTo:t.route})})).catch((function(e){return t.triggerError.emit(e)}))},e}();S.ɵfac=function(e){return new(e||S)(t.ɵɵdirectiveInject(p),t.ɵɵdirectiveInject(c.ActivatedRoute),t.ɵɵdirectiveInject(c.Router),t.ɵɵdirectiveInject(h))},S.ɵcmp=t.ɵɵdefineComponent({type:S,selectors:[["ng-component"]],decls:1,vars:4,consts:[[3,"form","submission","error","refresh","submit"]],template:function(e,r){1&e&&(t.ɵɵelementStart(0,"formio",0),t.ɵɵlistener("submit",(function(e){return r.onSubmit(e)})),t.ɵɵelementEnd()),2&e&&t.ɵɵproperty("form",r.service.form)("submission",r.service.resource)("error",r.triggerError)("refresh",r.service.refresh)},directives:[o.FormioComponent],encapsulation:2});var E=function(){function e(e,t,r){this.service=e,this.route=t,this.router=r}return e.prototype.onDelete=function(){var e=this;this.service.remove().then((function(){e.router.navigate(["../../"],{relativeTo:e.route})}))},e.prototype.onCancel=function(){this.router.navigate(["../","view"],{relativeTo:this.route})},e}();function C(e,r){if(1&e&&(t.ɵɵelementStart(0,"h3",2),t.ɵɵelementStart(1,"a",3),t.ɵɵelement(2,"i",4),t.ɵɵelementEnd(),t.ɵɵtext(3),t.ɵɵelementEnd()),2&e){var o=t.ɵɵnextContext();t.ɵɵadvance(3),t.ɵɵtextInterpolate1(" | New ",o.service.form.title,"\n")}}E.ɵfac=function(e){return new(e||E)(t.ɵɵdirectiveInject(p),t.ɵɵdirectiveInject(c.ActivatedRoute),t.ɵɵdirectiveInject(c.Router))},E.ɵcmp=t.ɵɵdefineComponent({type:E,selectors:[["ng-component"]],decls:7,vars:0,consts:[[1,"btn-toolbar"],["type","button",1,"btn","btn-danger",2,"margin-right","10px",3,"click"],["type","button",1,"btn","btn-danger",3,"click"]],template:function(e,r){1&e&&(t.ɵɵelementStart(0,"h3"),t.ɵɵtext(1,"Are you sure you wish to delete this record?"),t.ɵɵelementEnd(),t.ɵɵelementStart(2,"div",0),t.ɵɵelementStart(3,"button",1),t.ɵɵlistener("click",(function(){return r.onDelete()})),t.ɵɵtext(4,"Yes"),t.ɵɵelementEnd(),t.ɵɵelementStart(5,"button",2),t.ɵɵlistener("click",(function(){return r.onCancel()})),t.ɵɵtext(6,"No"),t.ɵɵelementEnd(),t.ɵɵelementEnd())},encapsulation:2});var w=function(){function e(e,r,o,n){this.service=e,this.route=r,this.router=o,this.config=n,this.onError=new t.EventEmitter,this.onSuccess=new t.EventEmitter}return e.prototype.ngOnInit=function(){this.service.setContext(this.route)},e.prototype.onSubmit=function(e){var t=this;this.service.save(e).then((function(){t.router.navigate(["../",t.service.resource._id,"view"],{relativeTo:t.route})})).catch((function(e){return t.onError.emit(e)}))},e}();w.ɵfac=function(e){return new(e||w)(t.ɵɵdirectiveInject(p),t.ɵɵdirectiveInject(c.ActivatedRoute),t.ɵɵdirectiveInject(c.Router),t.ɵɵdirectiveInject(h))},w.ɵcmp=t.ɵɵdefineComponent({type:w,selectors:[["ng-component"]],decls:2,vars:6,consts:[["style","margin-top:0;",4,"ngIf"],[3,"form","submission","refresh","error","success","submit"],[2,"margin-top","0"],["routerLink","../",1,"back-button"],[1,"fa","fa-chevron-left","glyphicon","glyphicon-chevron-left"]],template:function(e,r){1&e&&(t.ɵɵtemplate(0,C,4,1,"h3",0),t.ɵɵelementStart(1,"formio",1),t.ɵɵlistener("submit",(function(e){return r.onSubmit(e)})),t.ɵɵelementEnd()),2&e&&(t.ɵɵproperty("ngIf",r.service.form),t.ɵɵadvance(1),t.ɵɵproperty("form",r.service.form)("submission",r.service.resource)("refresh",r.service.refresh)("error",r.onError)("success",r.onSuccess))},directives:[u.NgIf,o.FormioComponent,c.RouterLinkWithHref],styles:[".back-button[_ngcontent-%COMP%]{font-size:.8em}"]});var I=function(){function e(e,t,r,o,n,i){this.service=e,this.route=t,this.router=r,this.config=o,this.cdr=n,this.ngZone=i}return e.prototype.ngOnInit=function(){var e=this;this.gridQuery={},this.service.setContext(this.route),this.service.formLoaded.then((function(){e.service&&e.config.parents&&e.config.parents.length?e.service.loadParents().then((function(t){s.each(t,(function(t){t&&t.filter&&(e.gridQuery["data."+t.name+"._id"]=t.resource._id)})),e.gridSrc=e.service.formUrl,e.createText="New "+e.service.form.title})):e.service.formUrl&&(e.gridSrc=e.service.formUrl,e.createText="New "+e.service.form.title),e.cdr.detectChanges()}))},e.prototype.onSelect=function(e){var t=this;this.ngZone.run((function(){t.router.navigate([e._id,"view"],{relativeTo:t.route})}))},e.prototype.onCreateItem=function(){var e=this;this.ngZone.run((function(){e.router.navigate(["new"],{relativeTo:e.route})}))},e}();function F(e){return[{path:"",component:e&&e.index?e.index:I},{path:"new",component:e&&e.create?e.create:w},{path:":id",component:e&&e.resource?e.resource:y,children:[{path:"",redirectTo:"view",pathMatch:"full"},{path:"view",component:e&&e.view?e.view:b},{path:"edit",component:e&&e.edit?e.edit:S},{path:"delete",component:e&&e.delete?e.delete:E}]}]}I.ɵfac=function(e){return new(e||I)(t.ɵɵdirectiveInject(p),t.ɵɵdirectiveInject(c.ActivatedRoute),t.ɵɵdirectiveInject(c.Router),t.ɵɵdirectiveInject(h),t.ɵɵdirectiveInject(t.ChangeDetectorRef),t.ɵɵdirectiveInject(t.NgZone))},I.ɵcmp=t.ɵɵdefineComponent({type:I,selectors:[["ng-component"]],decls:2,vars:5,consts:[[3,"alerts"],[3,"src","query","onForm","createText","rowSelect","error","createItem"]],template:function(e,r){1&e&&(t.ɵɵelement(0,"formio-alerts",0),t.ɵɵelementStart(1,"formio-grid",1),t.ɵɵlistener("rowSelect",(function(e){return r.onSelect(e)}))("error",(function(e){return r.service.onError(e)}))("createItem",(function(){return r.onCreateItem()})),t.ɵɵelementEnd()),2&e&&(t.ɵɵproperty("alerts",r.service.alerts),t.ɵɵadvance(1),t.ɵɵproperty("src",r.gridSrc)("query",r.gridQuery)("onForm",r.service.formLoaded)("createText",r.createText))},directives:[o.FormioAlertsComponent,a.FormioGridComponent],encapsulation:2});var R=function(){function e(){}return e.forChild=function(t){return o.extendRouter(e,t,F)},e.forRoot=function(t){return o.extendRouter(e,t,F)},e}();R.ɵmod=t.ɵɵdefineNgModule({type:R}),R.ɵinj=t.ɵɵdefineInjector({factory:function(e){return new(e||R)},providers:[o.FormioAlerts],imports:[[u.CommonModule,o.FormioModule,a.FormioGrid,c.RouterModule]]}),("undefined"==typeof ngJitMode||ngJitMode)&&t.ɵɵsetNgModuleScope(R,{declarations:[y,w,I,b,S,E],imports:[u.CommonModule,o.FormioModule,a.FormioGrid,c.RouterModule]}),e.FormioResource=R,e.FormioResourceComponent=y,e.FormioResourceConfig=h,e.FormioResourceCreateComponent=w,e.FormioResourceDeleteComponent=E,e.FormioResourceEditComponent=S,e.FormioResourceIndexComponent=I,e.FormioResourceRoutes=F,e.FormioResourceService=p,e.FormioResourceViewComponent=b,e.FormioResources=d,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=angular-formio-resource.umd.min.js.map